Comandos usados practica 1



============================================

Comandos usados practica 2



============================================

Comandos usados practica 3

## Preparación del sistema ##

# 1. Configurar Hostname
sudo hostnamectl set-hostname dc1.os3.inet
sudo nano /etc/hosts
192.168.122.143   dc1.os3.inet   dc1

# 3. Actualizar
sudo dnf -y update

# 4. Habilitar Repositorio EPEL 10
sudo dnf install https://dl.fedoraproject.org/pub/epel/epel-release-latest-10.noarch.rpm -y

# 5. Habilitar CodeReady Builder (CRB) para RHEL 10
sudo dnf config-manager --set-enabled codeready-builder-for-rhel-10-x86_64-rpms

# 6. Refrescar caché
sudo dnf makecache

## Instalación de Dependencias ##

# Herramientas básicas de compilación
sudo dnf install -y wget tar gcc make python3-devel \
    flex bison gdb git keyutils-libs-devel \
    libacl-devel libattr-devel libblkid-devel \
    libxml2-devel libxslt-devel \
    openldap-devel pam-devel popt-devel \
    readline-devel zlib-devel systemd-devel \
    lmdb-devel jansson-devel gpgme-devel \
    libarchive-devel libicu-devel \
    perl-ExtUtils-MakeMaker perl-Parse-Yapp \
    rpcgen libtirpc-devel
    
# Instalar librerías de criptografía y seguridad
sudo dnf install -y gnutls-devel python3-cryptography python3-dns


## Descarga y Compilación de Samba ##

# 1. Crear directorio y descargar
sudo mkdir -p /samba
cd /samba
sudo wget https://download.samba.org/pub/samba/stable/samba-4.21.1.tar.gz

# 2. Descomprimir
sudo tar -zxvf samba-4.21.1.tar.gz
cd samba-4.21.1/

# 3. Configurar la compilación
# Verificar que se tiene todo lo necesario
sudo ./configure --prefix=/usr/local/samba --enable-fhs --with-systemd --with-ads --with-ldap

# Instalamos dependencias de perl 
sudo dnf install perl-Parse-Yapp perl-Test-Simple perl-ExtUtils-MakeMaker -y
sudo dnf install perl-FindBin perl-lib perl-English -y

# 4. Compilar
sudo make

# 5. Instalar
sudo make install

## Configuración del Entorno (Para que la terminal reconozca los comandos samba y samba-tool) ##

# Agregar al PATH actual
export PATH=/usr/local/samba/bin:/usr/local/samba/sbin:$PATH

# Hacerlo permanente para tu usuario
echo 'export PATH=$PATH:/usr/local/samba/bin:/usr/local/samba/sbin' >> ~/.bashrc
source ~/.bashrc

## Aprovisionamiento del Dominio ##

sudo /usr/local/samba/bin/samba-tool domain provision \
 --use-rfc2307 \
 --interactive \
 --option="interfaces= lo enp1s0" \
 --option="bind interfaces only=yes"
 
Realm: OS3.inet
Domain: OS3-DOM
Server Role: dc
DNS backend: SAMBA_INTERNAL
DNS Forwarder IP address: 192.168.122.1
Administrator password: 20251335An

## Editamos el archivo de resolución DNS ##
sudo nano /etc/resolv.conf
nameserver 127.0.0.1
nameserver 8.8.8.8

## Configuración de Kerberos y Arranque ##

# 1. Copiar configuración de Kerberos

sudo cp /usr/local/samba/var/lib/samba/private/krb5.conf /etc/krb5.conf

# 2. Crear el servicio de Systemd (Para que inicie como servicio)
# Como compilamos, no se creó el servicio automático. Vamos a crearlo:
sudo nano /etc/systemd/system/samba-ad-dc.service

[Unit]
Description=Samba Active Directory Domain Controller
After=network.target remote-fs.target nss-lookup.target

[Service]
Type=forking
ExecStart=/usr/local/samba/sbin/samba -D
PIDFile=/usr/local/samba/var/run/samba.pid
ExecReload=/bin/kill -HUP $MAINPID

[Install]
WantedBy=multi-user.target

## Inicialización del servicio ##

Hacemos unos cambios en el archivo antes de iniciarlo:

sudo setenforce 0
sudo nano /etc/systemd/system/samba-ad-dc.service
Cambiar Type fork por Type simple
Cambiar ExecStart=.../samba -D a ExecStart=.../samba -i
Borrar PID File

sudo systemctl daemon-reload
sudo systemctl enable --now samba-ad-dc

## Configuración del Firewall ##

sudo firewall-cmd --permanent --add-service={dns,kerberos,ldap,ldaps}
sudo firewall-cmd --permanent --add-port={53,88,135,139,389,445,464,636,3268,3269}/tcp
sudo firewall-cmd --permanent --add-port={53,88,137,138,389,464}/udp
sudo firewall-cmd --reload

## Agregamos usuario ##

sudo /usr/local/samba/bin/samba-tool user add lanegracubana 20251335An

## Pruebas en Linux ##

# Verificar DNS
host -t SRV _ldap._tcp.os3.inet

# Verificar Autenticación
sudo dnf install krb5-workstation -y
kinit administrator
# (Poner la contraseña)

## En windows ##

(NOTA: ES IMPORTANTE APAGA EL FIREWALL EN NUESTRA VM DE LINUX PARA EVITAR ERRORES)

Propiedades IPv4 y en servidor DNS preferido ponemos la ip de nuestra maquina
en el cmd poner ping os3.inet
Win + R sysdm.cpl
Cambiar
Poner en miembro del dominio
Dominio: os3.inet
Usuario: Administrator
Clave: 20251335An
Reiniciamos y entramos

============================================
